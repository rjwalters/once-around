<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>Once Around the Night Sky</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #000;
        color: #fff;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        overflow: hidden;
      }

      /* Night Vision Mode - red filter for outdoor observing */
      body.night-vision {
        filter: sepia(100%) saturate(300%) brightness(70%) hue-rotate(-30deg);
      }

      body.night-vision #controls {
        background: rgba(30, 0, 0, 0.85);
        border-color: #500;
      }

      body.night-vision .tour-playback,
      body.night-vision .eclipse-banner {
        background: rgba(30, 0, 0, 0.95);
        border-color: #800;
      }

      #app {
        width: 100vw;
        height: 100vh;
        position: relative;
      }

      canvas {
        display: block;
      }

      #controls {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 16px;
        border-radius: 8px;
        min-width: 240px;
        z-index: 100;
      }

      #controls h2 {
        font-size: 14px;
        margin-bottom: 12px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .control-group {
        margin-bottom: 12px;
      }

      .control-group label {
        display: block;
        font-size: 12px;
        color: #aaa;
        margin-bottom: 4px;
      }

      .control-group input[type="range"] {
        width: 100%;
        accent-color: #4a9eff;
      }

      .control-group input[type="datetime-local"] {
        width: 100%;
        padding: 6px;
        background: #222;
        border: 1px solid #444;
        color: #fff;
        border-radius: 4px;
      }

      .time-step-controls {
        display: flex;
        gap: 4px;
        margin-top: 6px;
      }

      .time-step-btn {
        flex: 1;
        padding: 6px 12px;
        background: #333;
        border: 1px solid #555;
        color: #ccc;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.15s;
      }

      .time-step-btn:hover {
        background: #444;
        border-color: #666;
        color: #fff;
      }

      .time-step-btn:active {
        background: #555;
      }

      .time-step-unit {
        padding: 6px 10px;
        background: #2a3a4a;
        border: 1px solid #4a9eff;
        color: #4a9eff;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        min-width: 36px;
        transition: all 0.15s;
      }

      .time-step-unit:hover {
        background: #3a4a5a;
      }

      .time-play-btn {
        min-width: 36px;
      }

      .time-now-btn {
        color: #7eb8ff;
      }

      .time-now-btn:hover {
        color: #aad4ff;
        border-color: #7eb8ff;
      }

      .time-play-btn.playing {
        background: #2a4a3a;
        border-color: #4aff9e;
        color: #4aff9e;
      }

      .time-play-btn.playing:hover {
        background: #3a5a4a;
      }

      .eclipse-btn {
        margin-top: 6px;
        padding: 6px 12px;
        background: linear-gradient(135deg, #2a2a3a 0%, #3a2a3a 100%);
        border: 1px solid #664477;
        color: #cc88ff;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        width: 100%;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .eclipse-btn:hover {
        background: linear-gradient(135deg, #3a3a4a 0%, #4a3a4a 100%);
        border-color: #8855aa;
        color: #dd99ff;
      }

      .eclipse-btn:active {
        background: linear-gradient(135deg, #4a4a5a 0%, #5a4a5a 100%);
      }

      .eclipse-btn .icon {
        font-size: 14px;
      }

      .mag-hint {
        font-size: 10px;
        color: #666;
        margin-top: 4px;
        font-style: italic;
      }

      .checkbox-group label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 13px;
      }

      .checkbox-group input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: #4a9eff;
      }

      /* Keyboard shortcut hints */
      .shortcut {
        font-size: 10px;
        color: #666;
        margin-left: 4px;
        font-weight: normal;
      }

      /* Sky labels */
      .sky-label {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 11px;
        padding: 2px 4px;
        white-space: nowrap;
        pointer-events: none;
        user-select: none;
      }

      .planet-label {
        color: #ffcc66;
        font-weight: 500;
        text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
        pointer-events: auto !important;
        cursor: pointer;
        transition: color 0.15s, text-shadow 0.15s;
      }

      .planet-label:hover {
        color: #ffdd88;
        text-shadow: 0 0 8px rgba(255, 204, 102, 0.6);
      }

      .constellation-label {
        color: rgba(100, 160, 220, 0.7);
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
      }

      .star-label {
        color: #ff8844;
        font-weight: 500;
        text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
        pointer-events: auto !important;
        cursor: pointer;
        transition: color 0.15s, text-shadow 0.15s;
      }

      .star-label:hover {
        color: #ffaa66;
        text-shadow: 0 0 8px rgba(255, 136, 68, 0.6);
      }

      .video-label {
        color: #b366ff;
        font-size: 10px;
        font-weight: 500;
        text-shadow: 0 0 4px rgba(0, 0, 0, 0.9);
        pointer-events: none;
        text-align: center;
        white-space: nowrap;
      }

      .dso-label {
        color: #88ccff;
        font-size: 10px;
        font-weight: 500;
        text-shadow: 0 0 4px rgba(0, 0, 0, 0.9);
        pointer-events: auto !important;
        cursor: pointer;
        transition: color 0.15s, text-shadow 0.15s;
      }

      .dso-label:hover {
        color: #aaddff;
        text-shadow: 0 0 8px rgba(136, 204, 255, 0.6);
      }

      /* Video popup styles */
      .video-popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: opacity 0.2s ease;
      }

      .video-popup.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .video-popup-content {
        background: #1a1a2e;
        border-radius: 12px;
        padding: 20px;
        max-width: 640px;
        width: 90%;
        position: relative;
        box-shadow: 0 8px 32px rgba(100, 50, 200, 0.3);
        border: 1px solid #333;
      }

      .video-popup-close {
        position: absolute;
        top: 12px;
        right: 12px;
        background: none;
        border: none;
        color: #888;
        font-size: 24px;
        cursor: pointer;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
      }

      .video-popup-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
      }

      .video-popup-title {
        color: #b366ff;
        font-size: 16px;
        margin-bottom: 16px;
        padding-right: 40px;
      }

      .video-popup-embed {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        height: 0;
        overflow: hidden;
        border-radius: 8px;
        background: #000;
      }

      .video-popup-embed iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      #stats {
        font-size: 11px;
        color: #666;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #333;
      }

      /* About button */
      .about-button {
        margin-top: 12px;
        padding: 6px 12px;
        background: transparent;
        border: 1px solid #444;
        color: #888;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        width: 100%;
        transition: all 0.2s;
      }

      .about-button:hover {
        border-color: #666;
        color: #aaa;
        background: rgba(255, 255, 255, 0.05);
      }

      /* About modal */
      .about-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: opacity 0.2s ease;
      }

      .about-modal.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .about-content {
        background: #1a1a2e;
        border-radius: 12px;
        padding: 24px;
        max-width: 500px;
        width: 90%;
        position: relative;
        box-shadow: 0 8px 32px rgba(50, 100, 200, 0.3);
        border: 1px solid #333;
      }

      .about-close {
        position: absolute;
        top: 12px;
        right: 12px;
        background: none;
        border: none;
        color: #888;
        font-size: 24px;
        cursor: pointer;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
      }

      .about-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
      }

      .about-title {
        color: #4a9eff;
        font-size: 20px;
        margin-bottom: 16px;
      }

      .about-section {
        margin-bottom: 16px;
      }

      .about-section h3 {
        color: #888;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
      }

      .about-section p {
        color: #ccc;
        font-size: 13px;
        line-height: 1.6;
      }

      .about-section a {
        color: #4a9eff;
        text-decoration: none;
      }

      .about-section a:hover {
        text-decoration: underline;
      }

      .about-section ul {
        color: #aaa;
        font-size: 12px;
        line-height: 1.8;
        padding-left: 20px;
      }

      .about-section li {
        margin-bottom: 4px;
      }

      .about-footer {
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid #333;
        color: #666;
        font-size: 11px;
        text-align: center;
      }

      .build-info {
        color: #555;
        font-family: monospace;
        font-size: 10px;
      }

      /* Star info modal */
      .star-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: opacity 0.2s ease;
      }

      .star-modal.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .star-modal-content {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 12px;
        padding: 24px;
        max-width: 480px;
        width: 90%;
        position: relative;
        box-shadow: 0 8px 32px rgba(255, 136, 68, 0.2);
        border: 1px solid #333;
      }

      .star-modal-close {
        position: absolute;
        top: 12px;
        right: 12px;
        background: none;
        border: none;
        color: #888;
        font-size: 24px;
        cursor: pointer;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
      }

      .star-modal-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
      }

      .star-modal-header {
        margin-bottom: 16px;
        padding-right: 40px;
      }

      .star-modal-name {
        color: #ff8844;
        font-size: 24px;
        font-weight: 600;
        margin: 0 0 4px 0;
      }

      .star-modal-designation {
        color: #888;
        font-size: 13px;
        font-style: italic;
      }

      .star-modal-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
      }

      .star-stat {
        display: flex;
        flex-direction: column;
      }

      .star-stat-label {
        color: #666;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 2px;
      }

      .star-stat-value {
        color: #ccc;
        font-size: 13px;
      }

      .star-modal-type {
        color: #aaa;
        font-size: 12px;
        margin-bottom: 16px;
        padding: 8px 12px;
        background: rgba(255, 136, 68, 0.1);
        border-radius: 6px;
        border-left: 3px solid #ff8844;
      }

      .star-modal-description {
        color: #ccc;
        font-size: 13px;
        line-height: 1.7;
      }

      /* Constellation info modal */
      .constellation-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: opacity 0.2s ease;
      }

      .constellation-modal.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .constellation-modal-content {
        background: linear-gradient(135deg, #1a2a1e 0%, #162e21 100%);
        border-radius: 12px;
        padding: 24px;
        max-width: 520px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 8px 32px rgba(74, 158, 255, 0.2);
        border: 1px solid #2a4a3a;
      }

      .constellation-modal-close {
        position: absolute;
        top: 12px;
        right: 12px;
        background: none;
        border: none;
        color: #888;
        font-size: 24px;
        cursor: pointer;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
      }

      .constellation-modal-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
      }

      .constellation-modal-header {
        margin-bottom: 16px;
        padding-right: 40px;
      }

      .constellation-modal-name {
        color: #4a9eff;
        font-size: 24px;
        font-weight: 600;
        margin: 0 0 4px 0;
      }

      .constellation-modal-subtitle {
        color: #888;
        font-size: 13px;
      }

      .constellation-modal-subtitle .abbr {
        font-family: monospace;
        color: #6ab;
      }

      .constellation-modal-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
      }

      .constellation-stat {
        display: flex;
        flex-direction: column;
      }

      .constellation-stat-label {
        color: #666;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 2px;
      }

      .constellation-stat-value {
        color: #ccc;
        font-size: 13px;
      }

      .constellation-modal-objects {
        color: #aaa;
        font-size: 12px;
        margin-bottom: 16px;
        padding: 8px 12px;
        background: rgba(74, 158, 255, 0.1);
        border-radius: 6px;
        border-left: 3px solid #4a9eff;
      }

      .constellation-modal-objects-label {
        color: #666;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 6px;
        display: block;
      }

      .constellation-modal-description {
        color: #ccc;
        font-size: 13px;
        line-height: 1.7;
      }

      /* Make constellation labels clickable */
      .constellation-label {
        pointer-events: auto !important;
        cursor: pointer;
        transition: color 0.15s;
      }

      .constellation-label:hover {
        color: #4a9eff !important;
      }

      /* DSO (Deep Sky Object) info modal */
      .dso-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: opacity 0.2s ease;
      }

      .dso-modal.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .dso-modal-content {
        background: linear-gradient(135deg, #1a1e2e 0%, #161e3e 100%);
        border-radius: 12px;
        padding: 24px;
        max-width: 520px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 8px 32px rgba(136, 204, 255, 0.2);
        border: 1px solid #2a3a4a;
      }

      .dso-modal-close {
        position: absolute;
        top: 12px;
        right: 12px;
        background: none;
        border: none;
        color: #888;
        font-size: 24px;
        cursor: pointer;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
      }

      .dso-modal-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
      }

      .dso-modal-header {
        margin-bottom: 16px;
        padding-right: 40px;
      }

      .dso-modal-name {
        color: #88ccff;
        font-size: 24px;
        font-weight: 600;
        margin: 0 0 4px 0;
      }

      .dso-modal-subtitle {
        color: #888;
        font-size: 13px;
      }

      .dso-modal-type-badge {
        display: inline-block;
        padding: 2px 8px;
        background: rgba(136, 204, 255, 0.2);
        border-radius: 4px;
        font-size: 11px;
        color: #88ccff;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-left: 8px;
      }

      .dso-modal-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
      }

      .dso-stat {
        display: flex;
        flex-direction: column;
      }

      .dso-stat-label {
        color: #666;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 2px;
      }

      .dso-stat-value {
        color: #ccc;
        font-size: 13px;
      }

      .dso-modal-description {
        color: #ccc;
        font-size: 13px;
        line-height: 1.7;
      }

      #info {
        position: fixed;
        bottom: 20px;
        left: 20px;
        font-size: 12px;
        color: #666;
      }

      #coordinates {
        position: fixed;
        bottom: 20px;
        right: 20px;
        font-family: monospace;
        font-size: 12px;
        color: #4a4;
        background: rgba(0, 0, 0, 0.5);
        padding: 6px 10px;
        border-radius: 4px;
        z-index: 100;
      }

      #coordinates .label {
        color: #384;
        margin-right: 4px;
      }

      #coordinates .value {
        color: #6c6;
      }

      #crosshair {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        z-index: 50;
      }

      #crosshair::before,
      #crosshair::after {
        content: '';
        position: absolute;
        background: rgba(102, 204, 102, 0.6);
      }

      #crosshair::before {
        /* Horizontal line */
        width: 20px;
        height: 1px;
        left: -10px;
        top: 0;
      }

      #crosshair::after {
        /* Vertical line */
        width: 1px;
        height: 20px;
        left: 0;
        top: -10px;
      }

      #reference-circle {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        z-index: 49;
        border: 1px dashed rgba(255, 200, 100, 0.6);
        border-radius: 50%;
        /* Size will be set dynamically based on FOV */
        width: 50px;
        height: 50px;
        display: none; /* Hidden by default, shown when FOV < 5¬∞ */
      }

      #reference-circle::after {
        content: '50"';
        position: absolute;
        bottom: -18px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 10px;
        color: rgba(255, 200, 100, 0.8);
        white-space: nowrap;
      }

      #debug {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        padding: 12px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 11px;
        color: #0f0;
        line-height: 1.6;
      }

      /* Search */
      .search-group {
        position: relative;
      }

      .search-group input[type="text"] {
        width: 100%;
        padding: 6px 8px;
        background: #222;
        border: 1px solid #444;
        color: #fff;
        border-radius: 4px;
        font-size: 13px;
      }

      .search-group input[type="text"]:focus {
        outline: none;
        border-color: #4a9eff;
      }

      .search-group input[type="text"]::placeholder {
        color: #666;
      }

      .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 4px;
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 4px;
        max-height: 280px;
        overflow-y: auto;
        z-index: 200;
        display: none;
      }

      .search-results.visible {
        display: block;
      }

      .search-result {
        padding: 8px 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 1px solid #2a2a2a;
      }

      .search-result:last-child {
        border-bottom: none;
      }

      .search-result:hover,
      .search-result.selected {
        background: #2a2a2a;
      }

      .search-result-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .search-result-info {
        flex: 1;
        min-width: 0;
      }

      .search-result-name {
        font-size: 13px;
        color: #fff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .search-result-subtitle {
        font-size: 11px;
        color: #888;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .search-result-type {
        font-size: 10px;
        color: #666;
        text-transform: uppercase;
        flex-shrink: 0;
      }

      .search-empty {
        padding: 12px;
        text-align: center;
        color: #666;
        font-size: 12px;
      }

      /* Eclipse info banner */
      .eclipse-banner {
        position: fixed;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, rgba(40, 20, 60, 0.95) 0%, rgba(60, 30, 80, 0.95) 100%);
        border: 1px solid #8855aa;
        border-radius: 8px;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        z-index: 150;
        box-shadow: 0 4px 20px rgba(136, 85, 170, 0.3);
        transition: opacity 0.3s, transform 0.3s;
      }

      .eclipse-banner.hidden {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
        pointer-events: none;
      }

      .eclipse-banner-icon {
        font-size: 28px;
        filter: drop-shadow(0 0 8px rgba(255, 200, 100, 0.8));
      }

      .eclipse-banner-content {
        flex: 1;
      }

      .eclipse-banner-title {
        color: #cc88ff;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 2px;
      }

      .eclipse-banner-details {
        color: #aaa;
        font-size: 11px;
      }

      .eclipse-banner-separation {
        color: #88ff88;
        font-family: monospace;
        font-size: 12px;
        background: rgba(0, 0, 0, 0.3);
        padding: 6px 10px;
        border-radius: 4px;
      }

      /* Tour UI */
      .tour-section {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #333;
      }

      .tour-section-label {
        font-size: 11px;
        color: #666;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .tour-buttons {
        display: flex;
        gap: 6px;
      }

      .tour-btn {
        flex: 1;
        padding: 8px 6px;
        background: linear-gradient(135deg, #2a2a4a 0%, #3a2a4a 100%);
        border: 1px solid #554477;
        color: #aaaaff;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        transition: all 0.15s;
        font-size: 10px;
      }

      .tour-btn:hover {
        background: linear-gradient(135deg, #3a3a5a 0%, #4a3a5a 100%);
        border-color: #7755aa;
        color: #ccccff;
      }

      .tour-btn .tour-icon {
        font-size: 18px;
      }

      /* Tour playback bar */
      .tour-playback {
        position: fixed;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(20, 20, 40, 0.95);
        border: 1px solid #4455aa;
        border-radius: 10px;
        padding: 12px 16px;
        min-width: 360px;
        max-width: 90%;
        z-index: 200;
        box-shadow: 0 4px 20px rgba(68, 85, 170, 0.3);
        transition: opacity 0.3s, transform 0.3s;
      }

      .tour-playback.hidden {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
        pointer-events: none;
      }

      .tour-playback-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .tour-playback-name {
        color: #aaaaff;
        font-size: 13px;
        font-weight: 500;
      }

      .tour-playback-controls {
        display: flex;
        gap: 4px;
      }

      .tour-control-btn {
        width: 28px;
        height: 28px;
        background: #333;
        border: 1px solid #555;
        color: #ccc;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }

      .tour-control-btn:hover {
        background: #444;
        border-color: #666;
        color: #fff;
      }

      .tour-control-btn.stop-btn {
        color: #ff8888;
      }

      .tour-control-btn.stop-btn:hover {
        background: #4a3333;
        border-color: #885555;
      }

      .tour-progress-bar {
        height: 4px;
        background: #333;
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 8px;
      }

      .tour-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4a9eff 0%, #aa66ff 100%);
        border-radius: 2px;
        transition: width 0.1s linear;
        width: 0%;
      }

      .tour-caption {
        color: #aaa;
        font-size: 12px;
        font-style: italic;
        text-align: center;
        min-height: 18px;
      }

      .tour-caption.hidden {
        display: none;
      }

      /* AR Mode Button */
      .ar-mode-btn {
        margin-top: 8px;
        padding: 8px 12px;
        background: linear-gradient(135deg, #2a3a2a 0%, #2a4a3a 100%);
        border: 1px solid #447744;
        color: #88cc88;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        width: 100%;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .ar-mode-btn:hover {
        background: linear-gradient(135deg, #3a4a3a 0%, #3a5a4a 100%);
        border-color: #55aa55;
        color: #aaffaa;
      }

      .ar-mode-btn.active {
        background: linear-gradient(135deg, #2a5a3a 0%, #3a6a4a 100%);
        border-color: #66cc66;
        color: #aaffaa;
        box-shadow: 0 0 10px rgba(102, 204, 102, 0.3);
      }

      .ar-mode-btn.unsupported {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
      }

      .ar-mode-icon {
        font-size: 16px;
      }

      .ar-mode-status {
        position: fixed;
        bottom: 120px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: #aaa;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 12px;
        z-index: 200;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
      }

      .ar-mode-status.visible {
        opacity: 1;
      }

      /* Location Panel */
      .location-section {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #333;
      }

      .location-section-header {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
        font-size: 11px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .location-section-header .icon {
        font-size: 14px;
      }

      .location-search-group {
        position: relative;
        margin-bottom: 8px;
      }

      .location-search-group input[type="text"] {
        width: 100%;
        padding: 6px 8px;
        background: #222;
        border: 1px solid #444;
        color: #fff;
        border-radius: 4px;
        font-size: 13px;
      }

      .location-search-group input[type="text"]:focus {
        outline: none;
        border-color: #4a9eff;
      }

      .location-search-group input[type="text"]::placeholder {
        color: #666;
      }

      .location-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 4px;
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 200;
        display: none;
      }

      .location-results.visible {
        display: block;
      }

      .location-result {
        padding: 8px 10px;
        cursor: pointer;
        font-size: 12px;
        border-bottom: 1px solid #2a2a2a;
      }

      .location-result:last-child {
        border-bottom: none;
      }

      .location-result:hover,
      .location-result.selected {
        background: #2a2a2a;
      }

      .location-result-name {
        color: #fff;
      }

      .location-result-country {
        color: #888;
        margin-left: 4px;
      }

      .location-coords {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }

      .location-coord-input {
        flex: 1;
      }

      .location-coord-input label {
        display: block;
        font-size: 10px;
        color: #666;
        margin-bottom: 2px;
      }

      .location-coord-input input[type="number"] {
        width: 100%;
        padding: 4px 6px;
        background: #222;
        border: 1px solid #444;
        color: #fff;
        border-radius: 4px;
        font-size: 12px;
        font-family: monospace;
      }

      .location-coord-input input[type="number"]:focus {
        outline: none;
        border-color: #4a9eff;
      }

      .location-actions {
        display: flex;
        gap: 6px;
      }

      .location-btn {
        flex: 1;
        padding: 6px 8px;
        background: #333;
        border: 1px solid #555;
        color: #ccc;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }

      .location-btn:hover {
        background: #444;
        border-color: #666;
        color: #fff;
      }

      .location-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .location-current {
        margin-top: 8px;
        padding: 6px 8px;
        background: rgba(74, 158, 255, 0.1);
        border-radius: 4px;
        font-size: 11px;
      }

      .location-current-name {
        color: #4a9eff;
        font-weight: 500;
      }

      .location-current-coords {
        color: #888;
        font-family: monospace;
        font-size: 10px;
        margin-top: 2px;
      }

      /* Mobile Panel Toggle */
      .mobile-panel-toggle {
        display: none;
        position: fixed;
        top: 20px;
        left: 20px;
        width: 44px;
        height: 44px;
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid #444;
        border-radius: 8px;
        color: #888;
        font-size: 20px;
        cursor: pointer;
        z-index: 101;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .mobile-panel-toggle:hover {
        background: rgba(0, 0, 0, 0.85);
        border-color: #666;
        color: #fff;
      }

      .mobile-panel-toggle.active {
        background: rgba(74, 158, 255, 0.2);
        border-color: #4a9eff;
        color: #4a9eff;
      }

      /* Responsive Mobile Styles */
      @media (max-width: 600px) {
        .mobile-panel-toggle {
          display: flex;
        }

        #controls {
          top: 70px;
          left: 10px;
          right: 10px;
          width: auto;
          min-width: unset;
          max-height: 0;
          overflow: hidden;
          opacity: 0;
          padding: 0 16px;
          transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
        }

        #controls.expanded {
          max-height: calc(100vh - 180px);
          overflow-y: auto;
          opacity: 1;
          padding: 16px;
        }

        /* Larger touch targets */
        .time-step-btn,
        .time-step-unit,
        .eclipse-btn,
        .tour-btn,
        .ar-mode-btn,
        .about-button {
          min-height: 44px;
        }

        .checkbox-group label {
          min-height: 44px;
          display: flex;
          align-items: center;
        }

        .checkbox-group input[type="checkbox"] {
          width: 20px;
          height: 20px;
        }

        /* Prevent zoom on input focus */
        input[type="text"],
        input[type="datetime-local"] {
          font-size: 16px;
        }

        /* Adjust info text */
        #info {
          font-size: 10px;
          left: 10px;
          right: 10px;
          text-align: center;
        }

        /* Adjust coordinates display */
        #coordinates {
          right: 10px;
          font-size: 11px;
          padding: 4px 8px;
        }

        /* Adjust eclipse banner for mobile */
        .eclipse-banner {
          left: 10px;
          right: 10px;
          transform: none;
          flex-direction: column;
          gap: 8px;
          padding: 10px 14px;
        }

        .eclipse-banner.hidden {
          transform: translateY(20px);
        }

        /* Adjust tour playback for mobile */
        .tour-playback {
          left: 10px;
          right: 10px;
          transform: none;
          min-width: unset;
          max-width: none;
        }

        .tour-playback.hidden {
          transform: translateY(20px);
        }

        /* Hide keyboard shortcut hints on mobile */
        .shortcut {
          display: none;
        }
      }

      /* Extra small screens */
      @media (max-width: 400px) {
        .time-step-controls {
          flex-wrap: wrap;
        }

        .time-step-btn,
        .time-step-unit {
          flex: 1 1 30%;
        }
      }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <button id="mobile-panel-toggle" class="mobile-panel-toggle" aria-label="Toggle controls">‚ò∞</button>

    <div id="controls">
      <div class="control-group">
        <label>Date & Time (UTC)</label>
        <input type="datetime-local" id="datetime" />
        <div class="time-step-controls">
          <button id="time-now" class="time-step-btn time-now-btn" title="Jump to current time (N)">‚äô</button>
          <button id="time-back" class="time-step-btn" title="Step backward (‚Üê)">|‚óÄ</button>
          <button id="time-play" class="time-step-btn time-play-btn" title="Play/Pause (P)">‚ñ∂</button>
          <button id="time-step-unit" class="time-step-unit" title="Click to change step size">1h</button>
          <button id="time-forward" class="time-step-btn" title="Step forward (‚Üí)">‚ñ∂|</button>
        </div>
      </div>

      <div class="control-group search-group">
        <label>Search <span class="shortcut">(/)</span></label>
        <input type="text" id="search" placeholder="Planet, star, constellation..." autocomplete="off" />
        <div id="search-results" class="search-results"></div>
      </div>

      <div class="control-group">
        <label>Limiting Magnitude: <span id="mag-value">6.5</span></label>
        <input type="range" id="magnitude" min="-1" max="12" step="0.5" value="6.5" />
        <div class="mag-hint" id="mag-hint">Dark sky (naked eye limit)</div>
      </div>

      <div class="control-group checkbox-group">
        <label>
          <input type="checkbox" id="constellations" />
          Show constellations <span class="shortcut">(C)</span>
        </label>
      </div>

      <div class="control-group checkbox-group">
        <label>
          <input type="checkbox" id="labels" />
          Show labels <span class="shortcut">(L)</span>
        </label>
      </div>

      <div class="control-group checkbox-group">
        <label>
          <input type="checkbox" id="videos" checked />
          Show videos (107) <span class="shortcut">(V)</span>
        </label>
      </div>

      <div class="control-group checkbox-group">
        <label>
          <input type="checkbox" id="orbits" />
          Show orbits <span class="shortcut">(O)</span>
        </label>
      </div>

      <div class="control-group checkbox-group">
        <label>
          <input type="checkbox" id="dsos" />
          Show deep sky objects <span class="shortcut">(D)</span>
        </label>
      </div>

      <div class="control-group checkbox-group">
        <label>
          <input type="checkbox" id="night-vision" />
          Night vision mode <span class="shortcut">(R)</span>
        </label>
      </div>

      <div class="control-group checkbox-group">
        <label>
          <input type="checkbox" id="horizon" />
          Show horizon/ground <span class="shortcut">(H)</span>
        </label>
      </div>

      <button id="ar-mode-btn" class="ar-mode-btn" aria-pressed="false" title="Point your phone at the sky">
        <span class="ar-mode-icon">üì±</span>
        <span>AR Mode</span>
      </button>

      <div class="location-section">
        <div class="location-section-header">
          <span class="icon">üìç</span>
          <span>Observer Location</span>
        </div>
        <div class="location-search-group">
          <input type="text" id="location-search" placeholder="Search cities..." autocomplete="off" />
          <div id="location-results" class="location-results"></div>
        </div>
        <div class="location-coords">
          <div class="location-coord-input">
            <label>Latitude</label>
            <input type="number" id="location-lat" step="0.0001" min="-90" max="90" />
          </div>
          <div class="location-coord-input">
            <label>Longitude</label>
            <input type="number" id="location-lon" step="0.0001" min="-180" max="180" />
          </div>
        </div>
        <div class="location-actions">
          <button id="location-geolocate" class="location-btn" title="Use device GPS">
            <span>üìç</span> My Location
          </button>
        </div>
        <div class="location-current">
          <div class="location-current-name" id="location-name">San Francisco, USA</div>
          <div class="location-current-coords" id="location-coords-display">37.77¬∞ N, 122.42¬∞ W</div>
        </div>
      </div>

      <div id="stats">
        Visible: <span id="star-count">0</span> / <span id="total-stars">0</span><br />
        Rendered: <span id="rendered-stars">0</span>
      </div>

      <div class="tour-section">
        <div class="tour-section-label">Guided Tours</div>
        <div class="tour-buttons">
          <button class="tour-btn" id="next-eclipse" title="Jump to next total solar eclipse (E)">
            <span class="tour-icon">‚òÄ</span>
            <span>Next Eclipse <span class="shortcut">(E)</span></span>
          </button>
          <button class="tour-btn" data-tour="eclipse-2024" title="Watch the 2024 total solar eclipse">
            <span class="tour-icon">‚òÄ</span>
            <span>2024 Eclipse</span>
          </button>
          <button class="tour-btn" data-tour="jupiter-moons" title="Watch Jupiter's Galilean moons">
            <span class="tour-icon">‚ôÉ</span>
            <span>Jupiter Moons</span>
          </button>
        </div>
      </div>

      <button class="about-button" id="about-btn">About This Project</button>
    </div>

    <!-- Star Info Modal -->
    <div class="star-modal hidden" id="star-modal">
      <div class="star-modal-content">
        <button class="star-modal-close" id="star-modal-close">&times;</button>
        <div class="star-modal-header">
          <h2 class="star-modal-name" id="star-modal-name">Sirius</h2>
          <div class="star-modal-designation" id="star-modal-designation">Alpha Canis Majoris</div>
        </div>
        <div class="star-modal-stats">
          <div class="star-stat">
            <span class="star-stat-label">Constellation</span>
            <span class="star-stat-value" id="star-modal-constellation">Canis Major</span>
          </div>
          <div class="star-stat">
            <span class="star-stat-label">Magnitude</span>
            <span class="star-stat-value" id="star-modal-magnitude">-1.46</span>
          </div>
          <div class="star-stat">
            <span class="star-stat-label">Distance</span>
            <span class="star-stat-value" id="star-modal-distance">8.6 light-years</span>
          </div>
        </div>
        <div class="star-modal-type" id="star-modal-type">A1V - White main-sequence star</div>
        <p class="star-modal-description" id="star-modal-description">
          The brightest star in the night sky.
        </p>
      </div>
    </div>

    <!-- Constellation Info Modal -->
    <div class="constellation-modal hidden" id="constellation-modal">
      <div class="constellation-modal-content">
        <button class="constellation-modal-close" id="constellation-modal-close">&times;</button>
        <div class="constellation-modal-header">
          <h2 class="constellation-modal-name" id="constellation-modal-name">Orion</h2>
          <div class="constellation-modal-subtitle">
            <span class="abbr" id="constellation-modal-abbr">Ori</span> &bull;
            <span id="constellation-modal-meaning">The Hunter</span>
          </div>
        </div>
        <div class="constellation-modal-stats">
          <div class="constellation-stat">
            <span class="constellation-stat-label">Brightest Star</span>
            <span class="constellation-stat-value" id="constellation-modal-star">Rigel</span>
          </div>
          <div class="constellation-stat">
            <span class="constellation-stat-label">Area</span>
            <span class="constellation-stat-value" id="constellation-modal-area">594 sq¬∞</span>
          </div>
          <div class="constellation-stat">
            <span class="constellation-stat-label">Best Viewing</span>
            <span class="constellation-stat-value" id="constellation-modal-viewing">January</span>
          </div>
          <div class="constellation-stat">
            <span class="constellation-stat-label">Quadrant</span>
            <span class="constellation-stat-value" id="constellation-modal-quadrant">NQ1</span>
          </div>
        </div>
        <div class="constellation-modal-objects" id="constellation-modal-objects-container">
          <span class="constellation-modal-objects-label">Notable Objects</span>
          <span id="constellation-modal-objects">M42 Orion Nebula, Horsehead Nebula</span>
        </div>
        <p class="constellation-modal-description" id="constellation-modal-description">
          One of the most recognizable constellations in the sky.
        </p>
      </div>
    </div>

    <!-- DSO Info Modal -->
    <div class="dso-modal hidden" id="dso-modal">
      <div class="dso-modal-content">
        <button class="dso-modal-close" id="dso-modal-close">&times;</button>
        <div class="dso-modal-header">
          <h2 class="dso-modal-name" id="dso-modal-name">M31</h2>
          <div class="dso-modal-subtitle">
            <span id="dso-modal-common-name">Andromeda Galaxy</span>
            <span class="dso-modal-type-badge" id="dso-modal-type-badge">Galaxy</span>
          </div>
        </div>
        <div class="dso-modal-stats">
          <div class="dso-stat">
            <span class="dso-stat-label">Magnitude</span>
            <span class="dso-stat-value" id="dso-modal-magnitude">3.4</span>
          </div>
          <div class="dso-stat">
            <span class="dso-stat-label">Angular Size</span>
            <span class="dso-stat-value" id="dso-modal-size">190' √ó 60'</span>
          </div>
          <div class="dso-stat">
            <span class="dso-stat-label">Distance</span>
            <span class="dso-stat-value" id="dso-modal-distance">2.5 million light-years</span>
          </div>
          <div class="dso-stat">
            <span class="dso-stat-label">Coordinates</span>
            <span class="dso-stat-value" id="dso-modal-coords">RA 0h 42m, Dec +41¬∞</span>
          </div>
        </div>
        <p class="dso-modal-description" id="dso-modal-description">
          The nearest major galaxy to the Milky Way.
        </p>
      </div>
    </div>

    <!-- About Modal -->
    <div class="about-modal hidden" id="about-modal">
      <div class="about-content">
        <button class="about-close" id="about-close">&times;</button>
        <h2 class="about-title">Once Around the Night Sky</h2>

        <div class="about-section">
          <h3>About</h3>
          <p>
            An interactive visualizer for
            <a href="https://www.youtube.com/@oncearound" target="_blank" rel="noopener">Paul Fellows'</a>
            excellent "Once Around" series of astronomy YouTube videos.
            Explore the night sky and discover the celestial objects featured in the series.
          </p>
        </div>

        <div class="about-section">
          <h3>Data Sources</h3>
          <ul>
            <li><strong>Stars:</strong> Hipparcos Catalogue (~118,000 stars) with fallback to Yale Bright Star Catalog</li>
            <li><strong>Planets:</strong> VSOP87 planetary theory for high-precision positions</li>
            <li><strong>Moon:</strong> Simplified lunar ephemeris based on Meeus's Astronomical Algorithms</li>
            <li><strong>Constellations:</strong> IAU constellation boundaries with stick figures</li>
          </ul>
        </div>

        <div class="about-section">
          <h3>Links</h3>
          <p>
            <a href="https://www.youtube.com/@oncearound" target="_blank" rel="noopener">Once Around YouTube Channel</a><br>
            <a href="https://github.com/rjwalters/once-around" target="_blank" rel="noopener">GitHub Repository</a>
          </p>
        </div>

        <div class="about-footer">
          Built with Three.js and Rust/WebAssembly<br>
          <span id="build-info" class="build-info"></span>
        </div>
      </div>
    </div>

    <div id="info">Drag to look around | Scroll to zoom | ‚Üê/‚Üí = step time | P = play/pause | E = eclipse | R = night vision | Space = galactic center</div>

    <div id="ar-mode-status" class="ar-mode-status"></div>

    <div id="eclipse-banner" class="eclipse-banner hidden">
      <div class="eclipse-banner-icon">‚òÄ</div>
      <div class="eclipse-banner-content">
        <div class="eclipse-banner-title">Total Solar Eclipse</div>
        <div class="eclipse-banner-details">
          <span id="eclipse-banner-date"></span> &bull;
          <span id="eclipse-banner-path"></span> &bull;
          Duration: <span id="eclipse-banner-duration"></span>s
        </div>
      </div>
      <div class="eclipse-banner-separation">
        Sun-Moon: <span id="eclipse-banner-sep">--</span>¬∞
      </div>
    </div>

    <!-- Tour Playback Bar -->
    <div id="tour-playback" class="tour-playback hidden">
      <div class="tour-playback-header">
        <span id="tour-playback-name" class="tour-playback-name">Tour Name</span>
        <div class="tour-playback-controls">
          <button id="tour-prev" class="tour-control-btn" title="Previous">‚èÆ</button>
          <button id="tour-play-pause" class="tour-control-btn" title="Play/Pause">‚è∏</button>
          <button id="tour-next" class="tour-control-btn" title="Next">‚è≠</button>
          <button id="tour-stop" class="tour-control-btn stop-btn" title="Stop (Esc)">‚úï</button>
        </div>
      </div>
      <div class="tour-progress-bar">
        <div id="tour-progress" class="tour-progress-fill"></div>
      </div>
      <div id="tour-caption" class="tour-caption"></div>
    </div>

    <div id="crosshair"></div>
    <div id="reference-circle" title="50 arcsec reference circle"></div>

    <div id="coordinates">
      <span class="label">RA</span><span id="coord-ra" class="value">0h 0m</span>
      &nbsp;
      <span class="label">Dec</span><span id="coord-dec" class="value">+0¬∞ 0'</span>
      &nbsp;
      <span class="label">FOV</span><span id="coord-fov" class="value">60¬∞</span>
    </div>

    <!-- Debug panel: add ?debug to URL to show -->
    <div id="debug" style="display: none;">
      <div>View: Œ∏=<span id="dbg-theta">0</span>¬∞ œÜ=<span id="dbg-phi">0</span>¬∞</div>
      <div>Mouse down: (<span id="dbg-start-x">-</span>, <span id="dbg-start-y">-</span>)</div>
      <div>Mouse delta: (<span id="dbg-dx">-</span>, <span id="dbg-dy">-</span>)</div>
      <div>Angular Œî: Œ∏=<span id="dbg-dtheta">-</span>¬∞ œÜ=<span id="dbg-dphi">-</span>¬∞</div>
      <div>FOV: <span id="dbg-fov">60</span>¬∞</div>
    </div>
    <script>
      if (window.location.search.includes('debug')) {
        document.getElementById('debug').style.display = 'block';
      }

      // Mobile panel toggle
      const mobileToggle = document.getElementById('mobile-panel-toggle');
      const controlsPanel = document.getElementById('controls');
      if (mobileToggle && controlsPanel) {
        mobileToggle.addEventListener('click', () => {
          const isExpanded = controlsPanel.classList.toggle('expanded');
          mobileToggle.classList.toggle('active', isExpanded);
          mobileToggle.textContent = isExpanded ? '‚úï' : '‚ò∞';
        });
      }
    </script>

    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
